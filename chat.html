<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>jllm</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a0a; color: #fff; font-family: 'Inter', sans-serif; height: 100dvh; -webkit-font-smoothing: antialiased; }

  .nav { position: fixed; top: 16px; right: 24px; z-index: 10; display: flex; gap: 16px; }
  .nav a { font: 11px 'JetBrains Mono', monospace; color: #444; text-decoration: none; }
  .nav a:hover { color: #a855f7; }

  .page { height: 100dvh; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; }

  .msgs { flex: 1; overflow-y: auto; padding: 24px 16px; }
  .msgs::-webkit-scrollbar { width: 4px; }
  .msgs::-webkit-scrollbar-thumb { background: #222; border-radius: 2px; }

  .welcome { padding: 30vh 0; text-align: center; }
  .welcome h1 { font-size: 36px; font-weight: 600; background: linear-gradient(135deg, #a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
  .welcome p { font: 12px 'JetBrains Mono', monospace; color: #333; }

  .turn { margin-bottom: 32px; }
  .turn-label { font: 11px 'JetBrains Mono', monospace; color: #555; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  .turn-label.you { color: #a855f7; }
  .turn-text { font-size: 16px; line-height: 1.8; white-space: pre-wrap; word-break: break-word; color: #ddd; }
  .turn.user .turn-text { color: #fff; }

  .input-area { padding: 16px; border-top: 1px solid #1a1a1a; flex-shrink: 0; }
  .input-row { display: flex; gap: 12px; }
  .input-row textarea { flex: 1; background: #111; border: 1px solid #1f1f1f; border-radius: 14px; padding: 16px 20px; color: #fff; font: 16px 'Inter', sans-serif; outline: none; resize: none; height: 56px; line-height: 1.5; }
  .input-row textarea:focus { border-color: #a855f7; }
  .input-row textarea::placeholder { color: #444; }
  .send { background: linear-gradient(135deg, #a855f7, #ec4899); border: none; border-radius: 14px; width: 56px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.4; transition: opacity 0.2s; flex-shrink: 0; }
  .send.ready { opacity: 1; }
  .send:hover.ready { opacity: 0.85; }
  .send svg { width: 20px; height: 20px; fill: #fff; }
</style>
</head>
<body>

<div class="nav">
  <a href="lesson.html" target="_blank">lesson</a>
  <a href="pipeline.html" target="_blank">pipeline</a>
  <a href="tokenize.html" target="_blank">tokenizer</a>
</div>

<div class="page">
  <div class="msgs" id="msgs">
    <div class="welcome" id="welcome">
      <h1>jllm</h1>
      <p id="sub">connecting...</p>
    </div>
  </div>
  <div class="input-area">
    <div class="input-row">
      <textarea id="input" placeholder="Message jllm..." rows="1" disabled></textarea>
      <button class="send" id="send">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
var API = "http://localhost:8001";
var msgsEl = document.getElementById("msgs");
var inputEl = document.getElementById("input");
var sendEl = document.getElementById("send");
var subEl = document.getElementById("sub");
var welcomeEl = document.getElementById("welcome");
var chatHistory = [];
var busy = false;

function checkHealth() {
  fetch(API + "/health").then(function(r) { return r.json(); }).then(function(d) {
    if (d.ready) {
      subEl.textContent = "1.68B parameters · sft · ready";
      inputEl.disabled = false;
      sendEl.classList.add("ready");
      inputEl.focus();
    }
  }).catch(function() { setTimeout(checkHealth, 2000); });
}

function addTurn(who, text) {
  if (welcomeEl) { welcomeEl.remove(); welcomeEl = null; }
  var turn = document.createElement("div");
  turn.className = "turn " + who;
  var label = document.createElement("div");
  label.className = "turn-label" + (who === "user" ? " you" : "");
  label.textContent = who === "user" ? "you" : "jllm";
  var body = document.createElement("div");
  body.className = "turn-text";
  body.textContent = text;
  turn.appendChild(label);
  turn.appendChild(body);
  msgsEl.appendChild(turn);
  msgsEl.scrollTop = msgsEl.scrollHeight;
  return body;
}

async function send() {
  var text = inputEl.value.trim();
  if (!text || busy) return;
  busy = true;
  inputEl.value = "";
  inputEl.style.height = "56px";

  addTurn("user", text);
  chatHistory.push({ role: "user", content: text });

  var el = addTurn("assistant", "");
  var full = "";

  try {
    var res = await fetch(API + "/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: chatHistory, temperature: 0.8, max_tokens: 512, top_k: 50 })
    });
    var reader = res.body.getReader();
    var dec = new TextDecoder();
    var buf = "";
    while (true) {
      var chunk = await reader.read();
      if (chunk.done) break;
      buf += dec.decode(chunk.value, { stream: true });
      var lines = buf.split("\n");
      buf = lines.pop();
      for (var i = 0; i < lines.length; i++) {
        var ln = lines[i].trim();
        if (ln.startsWith("data: ")) {
          try {
            var tok = JSON.parse(ln.slice(6));
            if (tok.token) { full += tok.token; el.textContent = full; msgsEl.scrollTop = msgsEl.scrollHeight; }
          } catch(e) {}
        }
      }
    }
  } catch(e) {
    if (!full) { full = "(error)"; el.textContent = full; el.style.color = "#333"; }
  }

  chatHistory.push({ role: "assistant", content: full });
  busy = false;
  inputEl.focus();
}

/* Auto-resize textarea */
inputEl.addEventListener("input", function() {
  this.style.height = "56px";
  this.style.height = Math.min(this.scrollHeight, 160) + "px";
});

inputEl.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
});

sendEl.addEventListener("click", send);

checkHealth();
</script>
</body>
</html>
