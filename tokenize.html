<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>jllm tokenizer</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #000; --surface: #0a0a0a; --card: #111; --border: #1f1f1f;
    --text: #fff; --text-2: #999; --text-3: #555;
    --accent: #a855f7; --accent2: #ec4899;
    --mono: 'JetBrains Mono', monospace; --sans: 'Inter', sans-serif;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); height: 100dvh; display: flex; flex-direction: column; -webkit-font-smoothing: antialiased; overflow: hidden; }

  /* Header */
  .header { padding: 16px 40px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .logo { font-size: 20px; font-weight: 600; letter-spacing: -0.5px; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .logo span { font-weight: 300; -webkit-text-fill-color: var(--text-3); font-size: 14px; margin-left: 8px; letter-spacing: 0; }
  .stats { display: flex; gap: 24px; font-family: var(--mono); font-size: 12px; color: var(--text-3); }
  .stats .num { color: var(--accent); font-weight: 600; }

  /* Two-panel layout */
  .panels { flex: 1; display: flex; overflow: hidden; }

  /* Left panel: source text with highlights */
  .source-panel { width: 42%; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
  .source-header { padding: 16px 28px 12px; border-bottom: 1px solid var(--border); flex-shrink: 0; display: flex; align-items: center; gap: 12px; }
  .role-badge { display: inline-block; font-size: 10px; font-family: var(--mono); letter-spacing: 2px; text-transform: uppercase; padding: 3px 10px; border-radius: 6px; }
  .role-badge.user { background: rgba(168,85,247,0.15); color: var(--accent); }
  .role-badge.assistant { background: rgba(236,72,153,0.15); color: var(--accent2); }
  .msg-meta { font-size: 11px; font-family: var(--mono); color: var(--text-3); }
  .msg-meta .num { color: var(--accent); font-weight: 600; }

  .source-body { flex: 1; padding: 20px 28px; overflow-y: auto; line-height: 2.1; }
  .source-body::-webkit-scrollbar { width: 4px; }
  .source-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Each word in the source text */
  .word {
    display: inline; font-size: 15px; color: var(--text-3);
    transition: color 0.2s;
    border-bottom: 2px solid transparent;
    padding-bottom: 1px;
  }
  .word.active { color: var(--text); }
  .word.done { color: var(--text-2); }
  .word.single.done { border-bottom-color: rgba(34,197,94,0.4); }
  .word.multi.done { border-bottom-color: rgba(236,72,153,0.5); }

  /* Right panel: token breakdown */
  .token-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .token-header { padding: 16px 28px 12px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .token-header-row { display: flex; justify-content: space-between; align-items: center; }
  .token-title { font-size: 13px; font-family: var(--mono); color: var(--text-3); letter-spacing: 1px; }
  .legend { display: flex; gap: 16px; font-size: 11px; font-family: var(--mono); }
  .legend-item { display: flex; align-items: center; gap: 5px; color: var(--text-3); }
  .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
  .legend-dot.single { background: rgba(34,197,94,0.5); }
  .legend-dot.split { background: rgba(236,72,153,0.5); }

  .token-body { flex: 1; padding: 20px 28px; overflow-y: auto; }
  .token-body::-webkit-scrollbar { width: 4px; }
  .token-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .word-groups { display: flex; flex-wrap: wrap; gap: 6px; align-content: flex-start; }

  /* Word group: the word + its tokens */
  .word-group {
    display: inline-flex; flex-direction: column; align-items: center; gap: 3px;
    padding: 6px 8px 8px; border-radius: 10px;
    opacity: 0; transform: translateY(8px);
    transition: all 0.3s ease;
  }
  .word-group.show { opacity: 1; transform: translateY(0); }

  /* Single-token words: clean green tint */
  .word-group.single {
    background: rgba(34,197,94,0.06);
    border: 1px solid rgba(34,197,94,0.15);
  }
  /* Multi-token words: pink/accent tint â€” the interesting ones */
  .word-group.multi {
    background: rgba(236,72,153,0.08);
    border: 1px solid rgba(236,72,153,0.2);
  }

  /* The original word text above the tokens */
  .word-label { font-size: 12px; font-family: var(--sans); color: var(--text-2); font-weight: 500; white-space: nowrap; max-width: 160px; overflow: hidden; text-overflow: ellipsis; }
  .word-group.multi .word-label { color: var(--accent2); }

  /* The token chips inside the group */
  .token-chips { display: flex; gap: 2px; align-items: center; }

  .chip {
    display: inline-flex; align-items: center; gap: 3px;
    padding: 3px 7px; border-radius: 5px; font-family: var(--mono); font-size: 11px;
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
  }
  .chip .c-text { color: var(--text); font-weight: 600; }
  .chip .c-id { color: var(--text-3); font-size: 9px; }

  /* Split arrow between tokens of a multi-token word */
  .split-dot { color: var(--accent2); font-size: 8px; opacity: 0.5; }

  /* Conversation divider */
  .convo-divider { width: 100%; padding: 18px 0 10px; display: flex; align-items: center; gap: 12px; }
  .convo-divider .line { flex: 1; height: 1px; background: var(--border); }
  .convo-divider .label { font-size: 11px; font-family: var(--mono); color: var(--text-3); letter-spacing: 2px; text-transform: uppercase; white-space: nowrap; }

  /* Message divider in token panel */
  .msg-divider { width: 100%; padding: 10px 0 6px; }
  .msg-divider-inner { display: flex; align-items: center; gap: 8px; }
  .msg-divider .role-tag { font-size: 9px; font-family: var(--mono); letter-spacing: 1.5px; text-transform: uppercase; padding: 2px 8px; border-radius: 4px; }
  .msg-divider .role-tag.user { background: rgba(168,85,247,0.12); color: var(--accent); }
  .msg-divider .role-tag.assistant { background: rgba(236,72,153,0.12); color: var(--accent2); }
  .msg-divider .msg-line { flex: 1; height: 1px; background: var(--border); }
  .msg-divider .msg-count { font-size: 10px; font-family: var(--mono); color: var(--text-3); }

  /* Footer */
  .footer { padding: 12px 40px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  .footer-left { display: flex; gap: 24px; font-family: var(--mono); font-size: 12px; color: var(--text-3); }
  .footer-left .num { color: var(--accent); font-weight: 600; }
  .footer span { font-size: 11px; color: var(--text-3); font-family: var(--mono); }
</style>
</head>
<body>

<div class="header">
  <div class="logo">jllm <span>tokenizer</span></div>
  <div class="stats">
    <div>vocab <span class="num">32,768</span></div>
    <div>conversation <span class="num" id="convo-num">0</span> / <span id="convo-total">995</span></div>
  </div>
</div>

<div class="panels">
  <!-- Left: source text with word highlighting -->
  <div class="source-panel">
    <div class="source-header">
      <div class="role-badge user" id="role-badge">user</div>
      <div class="msg-meta"><span class="num" id="msg-token-count">0</span> tokens &middot; <span class="num" id="msg-compression">0</span>x</div>
    </div>
    <div class="source-body" id="source-body"></div>
  </div>

  <!-- Right: token groups -->
  <div class="token-panel">
    <div class="token-header">
      <div class="token-header-row">
        <div class="token-title">BPE TOKENS</div>
        <div class="legend">
          <div class="legend-item"><div class="legend-dot single"></div> 1 token</div>
          <div class="legend-item"><div class="legend-dot split"></div> split</div>
        </div>
      </div>
    </div>
    <div class="token-body" id="token-body">
      <div class="word-groups" id="word-groups"></div>
    </div>
  </div>
</div>

<div class="footer">
  <div class="footer-left">
    <div>total tokens <span class="num" id="total-tokens">0</span></div>
    <div>words split <span class="num" id="total-splits">0</span></div>
  </div>
  <span>streaming from lambda &middot; space to pause &middot; r to reset</span>
</div>

<script>
var API = "http://localhost:8091";
var playing = true;
var globalTokenCount = 0;
var globalSplitCount = 0;
var queue = [];

/* DOM refs */
var convoNumEl = document.getElementById("convo-num");
var convoTotalEl = document.getElementById("convo-total");
var totalTokensEl = document.getElementById("total-tokens");
var totalSplitsEl = document.getElementById("total-splits");
var roleBadgeEl = document.getElementById("role-badge");
var msgTokenCountEl = document.getElementById("msg-token-count");
var msgCompressionEl = document.getElementById("msg-compression");
var sourceBodyEl = document.getElementById("source-body");
var wordGroupsEl = document.getElementById("word-groups");
var tokenBodyEl = document.getElementById("token-body");

/**
 * Group an array of tokens into "words".
 * A new word starts when a token's text begins with a space (or is the first token).
 * Returns [{word: "Hello", tokens: [{id, text, bytes}]}, ...]
 */
function groupIntoWords(tokens) {
  var words = [];
  var current = null;

  for (var i = 0; i < tokens.length; i++) {
    var tok = tokens[i];
    var text = tok.text;
    /* New word if: first token, or starts with space, or previous was pure punctuation */
    var startsWord = (i === 0) || /^\s/.test(text);

    if (startsWord) {
      if (current) words.push(current);
      current = { word: text, tokens: [tok] };
    } else {
      current.word += text;
      current.tokens.push(tok);
    }
  }
  if (current) words.push(current);
  return words;
}

/**
 * Build the highlighted source text from word groups.
 * Each word gets a span that can be highlighted.
 */
function buildSourceText(wordGroups) {
  sourceBodyEl.textContent = "";
  wordGroups.forEach(function(wg, i) {
    var span = document.createElement("span");
    span.className = "word";
    span.setAttribute("data-idx", i);
    span.textContent = wg.word;
    if (wg.tokens.length > 1) {
      span.classList.add("multi");
    } else {
      span.classList.add("single");
    }
    sourceBodyEl.appendChild(span);
  });
}

/**
 * Highlight a word in the source panel.
 */
function highlightWord(idx) {
  var words = sourceBodyEl.querySelectorAll(".word");
  words.forEach(function(w) { w.classList.remove("active"); });
  if (idx < words.length) {
    words[idx].classList.add("active");
    words[idx].classList.add("done");
    /* Scroll into view if needed */
    words[idx].scrollIntoView({ block: "nearest", behavior: "smooth" });
  }
}

/**
 * Add a word group to the token panel.
 */
function addWordGroup(wg, idx) {
  var group = document.createElement("div");
  var isMulti = wg.tokens.length > 1;
  group.className = "word-group " + (isMulti ? "multi" : "single");

  /* Word label */
  var label = document.createElement("div");
  label.className = "word-label";
  var displayWord = wg.word.replace(/^\s+/, "");
  if (!displayWord) displayWord = wg.word.replace(/ /g, "\u00B7").replace(/\n/g, "\\n");
  label.textContent = displayWord;
  group.appendChild(label);

  /* Token chips */
  var chips = document.createElement("div");
  chips.className = "token-chips";
  wg.tokens.forEach(function(tok, ti) {
    if (ti > 0 && isMulti) {
      var dot = document.createElement("span");
      dot.className = "split-dot";
      dot.textContent = "\u00B7";
      chips.appendChild(dot);
    }
    var chip = document.createElement("span");
    chip.className = "chip";

    var cText = document.createElement("span");
    cText.className = "c-text";
    var t = tok.text.replace(/^\s+/, "");
    if (!t) t = "\u00B7";
    cText.textContent = t;
    chip.appendChild(cText);

    var cId = document.createElement("span");
    cId.className = "c-id";
    cId.textContent = tok.id;
    chip.appendChild(cId);

    chips.appendChild(chip);
  });
  group.appendChild(chips);
  wordGroupsEl.appendChild(group);

  /* Animate in */
  requestAnimationFrame(function() {
    requestAnimationFrame(function() { group.classList.add("show"); });
  });

  /* Scroll to bottom */
  tokenBodyEl.scrollTop = tokenBodyEl.scrollHeight;

  /* Update counters */
  globalTokenCount += wg.tokens.length;
  totalTokensEl.textContent = globalTokenCount.toLocaleString();
  if (isMulti) {
    globalSplitCount++;
    totalSplitsEl.textContent = globalSplitCount.toLocaleString();
  }
}

/**
 * Add a conversation divider.
 */
function addConvoDivider(num) {
  var div = document.createElement("div");
  div.className = "convo-divider";
  var l1 = document.createElement("div"); l1.className = "line";
  var lbl = document.createElement("div"); lbl.className = "label"; lbl.textContent = "conversation " + num;
  var l2 = document.createElement("div"); l2.className = "line";
  div.appendChild(l1); div.appendChild(lbl); div.appendChild(l2);
  wordGroupsEl.appendChild(div);
}

/**
 * Add a message divider in the token panel.
 */
function addMsgDivider(role, tokenCount) {
  var div = document.createElement("div");
  div.className = "msg-divider";
  var inner = document.createElement("div");
  inner.className = "msg-divider-inner";
  var tag = document.createElement("span");
  tag.className = "role-tag " + role;
  tag.textContent = role;
  var line = document.createElement("div");
  line.className = "msg-line";
  var count = document.createElement("span");
  count.className = "msg-count";
  count.textContent = tokenCount + " tokens";
  inner.appendChild(tag); inner.appendChild(line); inner.appendChild(count);
  div.appendChild(inner);
  wordGroupsEl.appendChild(div);
}

/**
 * Play through the queue.
 */
function playNext() {
  if (!playing || queue.length === 0) {
    if (playing) fetchNext();
    return;
  }

  var item = queue.shift();

  if (item.type === "convo") {
    addConvoDivider(item.num);
    convoNumEl.textContent = item.num;
    setTimeout(playNext, 400);

  } else if (item.type === "message") {
    /* New message: build source text, add divider */
    var msg = item.data;
    var words = groupIntoWords(msg.tokens);
    buildSourceText(words);
    roleBadgeEl.className = "role-badge " + msg.role;
    roleBadgeEl.textContent = msg.role;
    msgTokenCountEl.textContent = msg.token_count;
    msgCompressionEl.textContent = msg.compression;
    addMsgDivider(msg.role, msg.token_count);
    /* Queue each word group */
    words.forEach(function(wg, wi) {
      queue.splice(wi, 0, { type: "word", group: wg, idx: wi, totalWords: words.length });
    });
    /* Actually we need to insert at front of queue, after the words already there */
    /* Let me restructure: the words are already queued by the fetch step */
    setTimeout(playNext, 300);

  } else if (item.type === "word") {
    highlightWord(item.idx);
    addWordGroup(item.group, item.idx);
    /* Timing: multi-token words get more time to appreciate the split */
    var delay = item.group.tokens.length > 1 ? 250 : 100;
    /* Longer pause at end of message */
    if (item.lastWord) delay = 600;
    setTimeout(playNext, delay);
  }
}

/**
 * Fetch and queue the next conversation.
 */
function fetchNext() {
  if (!playing) return;

  fetch(API + "/next")
    .then(function(r) { return r.json(); })
    .then(function(data) {
      convoTotalEl.textContent = data.total_conversations;
      queue.push({ type: "convo", num: data.conversation_num });

      data.messages.forEach(function(msg, mi) {
        /* Pre-group words so we can queue them properly */
        var words = groupIntoWords(msg.tokens);
        queue.push({ type: "message", data: msg });
        words.forEach(function(wg, wi) {
          queue.push({
            type: "word",
            group: wg,
            idx: wi,
            totalWords: words.length,
            lastWord: (wi === words.length - 1),
          });
        });
      });

      playNext();
    })
    .catch(function(err) {
      console.error("Fetch error:", err);
      setTimeout(fetchNext, 2000);
    });
}

/* Start */
fetchNext();

/* Keyboard controls */
document.addEventListener("keydown", function(e) {
  if (e.key === " ") {
    e.preventDefault();
    playing = !playing;
    if (playing) playNext();
  } else if (e.key === "r" || e.key === "R") {
    fetch(API + "/reset");
    wordGroupsEl.textContent = "";
    sourceBodyEl.textContent = "";
    globalTokenCount = 0;
    globalSplitCount = 0;
    totalTokensEl.textContent = "0";
    totalSplitsEl.textContent = "0";
    queue = [];
    playing = true;
    fetchNext();
  }
});
</script>
</body>
</html>
