<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>jllm training</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #000; --surface: #0a0a0a; --card: #111; --border: #1f1f1f;
    --text: #fff; --text-2: #999; --text-3: #555;
    --accent: #a855f7; --accent2: #ec4899;
    --green: #22c55e; --blue: #3b82f6; --yellow: #eab308; --red: #ef4444;
    --mono: 'JetBrains Mono', monospace; --sans: 'Inter', sans-serif;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); height: 100dvh; display: flex; flex-direction: column; -webkit-font-smoothing: antialiased; overflow: hidden; }

  /* Header */
  .header { padding: 16px 40px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .logo { font-size: 20px; font-weight: 600; letter-spacing: -0.5px; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .logo span { font-weight: 300; -webkit-text-fill-color: var(--text-3); font-size: 14px; margin-left: 8px; letter-spacing: 0; }
  .status { display: flex; align-items: center; gap: 8px; font-family: var(--mono); font-size: 12px; color: var(--text-3); }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:0.4} 50%{opacity:1} }

  /* Big numbers row */
  .hero { padding: 28px 40px; display: flex; gap: 40px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .hero-stat { display: flex; flex-direction: column; gap: 4px; }
  .hero-label { font-size: 10px; font-family: var(--mono); letter-spacing: 2px; text-transform: uppercase; color: var(--text-3); }
  .hero-value { font-size: 36px; font-weight: 700; font-family: var(--mono); letter-spacing: -1px; }
  .hero-value.loss { color: var(--accent); }
  .hero-value.step { color: var(--text); }
  .hero-value.speed { color: var(--green); }
  .hero-value.mfu { color: var(--blue); }
  .hero-value.time { color: var(--text-2); }
  .hero-sub { font-size: 11px; font-family: var(--mono); color: var(--text-3); }

  /* Progress bar */
  .progress-wrap { padding: 0 40px 20px; flex-shrink: 0; }
  .progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 2px; transition: width 0.5s ease; width: 0%; }
  .progress-labels { display: flex; justify-content: space-between; margin-top: 6px; font-size: 10px; font-family: var(--mono); color: var(--text-3); }

  /* Chart area */
  .chart-area { flex: 1; padding: 20px 40px; display: flex; gap: 20px; overflow: hidden; }

  .chart-container { flex: 1; display: flex; flex-direction: column; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
  .chart-title { padding: 12px 20px; font-size: 11px; font-family: var(--mono); letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-3); border-bottom: 1px solid var(--border); }
  .chart-canvas-wrap { flex: 1; padding: 12px; position: relative; }
  canvas { width: 100%; height: 100%; }

  /* Footer with recent steps */
  .footer { padding: 12px 40px; border-top: 1px solid var(--border); flex-shrink: 0; overflow: hidden; }
  .step-ticker { display: flex; gap: 4px; overflow: hidden; font-family: var(--mono); font-size: 11px; }
  .tick { padding: 4px 10px; border-radius: 6px; background: var(--card); border: 1px solid var(--border); white-space: nowrap; opacity: 0; transform: translateX(20px); transition: all 0.3s ease; }
  .tick.show { opacity: 1; transform: translateX(0); }
  .tick .t-step { color: var(--text-3); }
  .tick .t-loss { color: var(--accent); font-weight: 600; }
</style>
</head>
<body>

<div class="header">
  <div class="logo">jllm <span>SFT training</span></div>
  <div class="status"><div class="status-dot"></div> <span id="status-text">connecting...</span></div>
</div>

<div class="hero">
  <div class="hero-stat">
    <div class="hero-label">loss</div>
    <div class="hero-value loss" id="h-loss">--</div>
    <div class="hero-sub" id="h-loss-delta"></div>
  </div>
  <div class="hero-stat">
    <div class="hero-label">step</div>
    <div class="hero-value step" id="h-step">0</div>
    <div class="hero-sub" id="h-progress">0%</div>
  </div>
  <div class="hero-stat">
    <div class="hero-label">tokens/sec</div>
    <div class="hero-value speed" id="h-speed">--</div>
    <div class="hero-sub">across 8x H100</div>
  </div>
  <div class="hero-stat">
    <div class="hero-label">MFU</div>
    <div class="hero-value mfu" id="h-mfu">--</div>
    <div class="hero-sub">model flop utilization</div>
  </div>
  <div class="hero-stat">
    <div class="hero-label">time</div>
    <div class="hero-value time" id="h-time">0m</div>
    <div class="hero-sub" id="h-eta">--</div>
  </div>
</div>

<div class="progress-wrap">
  <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  <div class="progress-labels">
    <span>epoch <span id="p-epoch">1</span></span>
    <span id="p-percent">0%</span>
    <span id="p-steps">step 0 / ~500</span>
  </div>
</div>

<div class="chart-area">
  <div class="chart-container">
    <div class="chart-title">training loss</div>
    <div class="chart-canvas-wrap">
      <canvas id="loss-chart"></canvas>
    </div>
  </div>
  <div class="chart-container">
    <div class="chart-title">tokens / sec</div>
    <div class="chart-canvas-wrap">
      <canvas id="speed-chart"></canvas>
    </div>
  </div>
</div>

<div class="footer">
  <div class="step-ticker" id="ticker"></div>
</div>

<script>
var API = "http://localhost:8092";
var cursor = 0;
var allMetrics = [];
var lossChart, speedChart;

/* DOM refs */
var hLoss = document.getElementById("h-loss");
var hLossDelta = document.getElementById("h-loss-delta");
var hStep = document.getElementById("h-step");
var hProgress = document.getElementById("h-progress");
var hSpeed = document.getElementById("h-speed");
var hMfu = document.getElementById("h-mfu");
var hTime = document.getElementById("h-time");
var hEta = document.getElementById("h-eta");
var progressFill = document.getElementById("progress-fill");
var pEpoch = document.getElementById("p-epoch");
var pPercent = document.getElementById("p-percent");
var pSteps = document.getElementById("p-steps");
var statusText = document.getElementById("status-text");
var tickerEl = document.getElementById("ticker");

/* Simple canvas line chart */
function drawChart(canvas, data, color, label) {
  var ctx = canvas.getContext("2d");
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + "px";
  canvas.style.height = rect.height + "px";
  ctx.scale(dpr, dpr);
  var w = rect.width;
  var h = rect.height;

  ctx.clearRect(0, 0, w, h);

  if (data.length < 2) return;

  var min = Math.min.apply(null, data);
  var max = Math.max.apply(null, data);
  var range = max - min || 1;
  var pad = range * 0.1;
  min -= pad;
  max += pad;

  /* Grid lines */
  ctx.strokeStyle = "rgba(255,255,255,0.04)";
  ctx.lineWidth = 1;
  for (var g = 0; g < 5; g++) {
    var gy = h - (h * (g / 4));
    ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke();
  }

  /* Y-axis labels */
  ctx.fillStyle = "rgba(255,255,255,0.2)";
  ctx.font = "10px 'JetBrains Mono'";
  ctx.textAlign = "right";
  for (var g = 0; g < 5; g++) {
    var val = min + ((max - min) * (g / 4));
    var gy = h - (h * (g / 4));
    ctx.fillText(val.toFixed(3), w - 4, gy - 4);
  }

  /* Line */
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.lineJoin = "round";
  ctx.beginPath();
  for (var i = 0; i < data.length; i++) {
    var x = (i / (data.length - 1)) * w;
    var y = h - ((data[i] - min) / (max - min)) * h;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();

  /* Gradient fill under */
  ctx.lineTo(w, h);
  ctx.lineTo(0, h);
  ctx.closePath();
  var grad = ctx.createLinearGradient(0, 0, 0, h);
  grad.addColorStop(0, color.replace(")", ",0.15)").replace("rgb", "rgba"));
  grad.addColorStop(1, color.replace(")", ",0.0)").replace("rgb", "rgba"));
  ctx.fillStyle = grad;
  ctx.fill();

  /* Latest value dot */
  var lastX = w;
  var lastY = h - ((data[data.length - 1] - min) / (max - min)) * h;
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(lastX, lastY, 4, 0, Math.PI * 2);
  ctx.fill();
}

function updateCharts() {
  var losses = [];
  var speeds = [];
  allMetrics.forEach(function(m) {
    if (m.loss !== undefined) {
      losses.push(m.loss);
      speeds.push(m.tok_per_sec);
    }
  });
  drawChart(document.getElementById("loss-chart"), losses, "rgb(168,85,247)", "loss");
  drawChart(document.getElementById("speed-chart"), speeds, "rgb(34,197,94)", "tok/sec");
}

function addTick(m) {
  var el = document.createElement("div");
  el.className = "tick";

  var step = document.createElement("span");
  step.className = "t-step";
  step.textContent = "s" + m.step + " ";
  el.appendChild(step);

  var loss = document.createElement("span");
  loss.className = "t-loss";
  loss.textContent = m.loss.toFixed(4);
  el.appendChild(loss);

  /* Prepend so newest is on left */
  if (tickerEl.firstChild) {
    tickerEl.insertBefore(el, tickerEl.firstChild);
  } else {
    tickerEl.appendChild(el);
  }
  requestAnimationFrame(function() {
    requestAnimationFrame(function() { el.classList.add("show"); });
  });

  /* Keep max 30 ticks */
  while (tickerEl.children.length > 30) {
    tickerEl.removeChild(tickerEl.lastChild);
  }
}

function updateHero(m) {
  if (m.loss !== undefined) {
    hLoss.textContent = m.loss.toFixed(4);
    /* Show delta from first loss */
    if (allMetrics.length > 1) {
      var first = allMetrics[0].loss || allMetrics[1].loss;
      if (first) {
        var delta = m.loss - first;
        hLossDelta.textContent = (delta < 0 ? "" : "+") + delta.toFixed(4);
        hLossDelta.style.color = delta < 0 ? "#22c55e" : "#ef4444";
      }
    }
    hSpeed.textContent = (m.tok_per_sec / 1000).toFixed(0) + "K";
    hMfu.textContent = m.mfu.toFixed(1) + "%";
    hTime.textContent = m.total_time_min < 60 ? m.total_time_min.toFixed(1) + "m" : (m.total_time_min / 60).toFixed(1) + "h";

    /* ETA estimate */
    if (m.progress > 0) {
      var elapsed = m.total_time_min;
      var total_est = elapsed / (m.progress / 100);
      var remaining = total_est - elapsed;
      hEta.textContent = "~" + (remaining < 60 ? remaining.toFixed(0) + "m left" : (remaining / 60).toFixed(1) + "h left");
    }
  }
  hStep.textContent = m.step;
  hProgress.textContent = (m.progress || 0).toFixed(1) + "%";
  progressFill.style.width = (m.progress || 0) + "%";
  pPercent.textContent = (m.progress || 0).toFixed(1) + "%";
  pEpoch.textContent = m.epoch || 1;
  pSteps.textContent = "step " + m.step + " / ~500";
}

function fetchMetrics() {
  fetch(API + "/since/" + cursor)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      statusText.textContent = "live on 8x H100";
      if (data.metrics && data.metrics.length > 0) {
        data.metrics.forEach(function(m) {
          allMetrics.push(m);
          if (m.loss !== undefined) addTick(m);
        });
        cursor = data.total;

        /* Update displays with latest */
        var latest = data.metrics[data.metrics.length - 1];
        updateHero(latest);
        updateCharts();
      }
    })
    .catch(function() {
      statusText.textContent = "connecting...";
    });
}

/* Poll every 2 seconds */
fetchMetrics();
setInterval(fetchMetrics, 2000);

/* Redraw charts on resize */
window.addEventListener("resize", updateCharts);
</script>
</body>
</html>
